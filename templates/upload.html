<!DOCTYPE html>
<html>
<head>
    <title>Upload your data</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
    $(document).ready(function(){
        // Function to update the image source and display the analysis image
        function updateAnalysisImage(imageUrl) {
            $('#analysis-image').hide();
            $('#analysis-image').on('load', function() {
                $(this).show();
            }).on('error', function() {
                alert('Failed to load image, please try again.');
                $(this).hide();
            });
            $('#analysis-image').attr('src', imageUrl);
        }
        function updateResultImage(imageUrl) {
            console.log("Function called with URL: ", imageUrl);
            $('#result-image').hide();
            $('#result-image').on('load', function() {
                $(this).show();
            }).on('error', function() {
                alert('Failed to load image, please try again.');
                $(this).hide();
            });
            $('#result-image').attr('src', imageUrl);
        }


        $("form").submit(function(event){
            event.preventDefault();  // 阻止表单默认提交
            var formData = new FormData(this);
            $.ajax({
                url: '/upload',
                type: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                success: function(response) {
                    $("#message").text(response.message).show();  // 显示消息
                    setTimeout(function() { $("#message").hide(); }, 3000); // 3秒后隐藏消息
                    $("#display-btn").show(); // 显示"显示数据"按钮
                    $("#analyze-btn").show(); // 显示"开始数据分析"按钮
                },
                error: function() {
                    $("#message").text("Upload failed").show();
                    setTimeout(function() { $("#message").hide(); }, 3000);
                }
            });
        });

        $("#display-btn").click(function(){
            $.ajax({
                url: "/display-data",
                type: "GET",
                success: function(response) {
                    $("#data-display").html(response).show();
                },
                error: function() {
                    $("#data-display").text("Error loading data.").show();
                }
            });
        });


        $("#analyze-btn").click(function(){
            $.ajax({
                url: "/pre-analyze",
                type: "GET",
                success: function(response) {
                    alert(response.message);
                    $("#learning-options").show(); // 显示学习类型选项
                }
            });
        });

        $("#unsupervised-btn").click(function(){
            // Handle unsupervised learning choice
            alert("Unsupervised learning is currently not supported.");
        });

        $("#supervised-btn").click(function(){
            // Handle supervised learning choice
            alert("Please proceed with supervised learning.");
            $("#supervised-options").show(); // 显示学习类型选项
        });

        $("#submit-supervised-btn").click(function(){
            var labelName = $("#label-input").val();
            var excludeInput = $("#exclude-features-input").val();
            var groupByFeature = $("#group-by-input").val();
            var excludedFeatures = excludeInput ? excludeInput.split(",").map(function(item) {
                return item.trim();
            }).filter(function(item) { return item !== ""; }) : [];
            var isTimeSeries = $("#time-series-select").val();
            $.ajax({
                url: "/set-supervised-options",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                    label: labelName, excludedFeatures: excludedFeatures,
                    isTimeSeries: isTimeSeries,
                    groupBy: groupByFeature
                }),
                success: function(response) {
                    alert(response.message);
                    $("#visualization").show();
                },
                error: function() {
                    alert("Error setting supervised options.");
                }
            });
        });

        // Show analysis options when the visualization button is clicked
        $("#visualization").click(function(){
            $("#analysis-options").show(); // Show the buttons for different analyses
        });

        // Click handler for histogram analysis
         $("#histogram-analysis").click(function() {
            var d = new Date(); // To prevent image caching
            updateAnalysisImage("/generate_histogram?" + d.getTime());
        });

        // Click handler for scatter analysis
        $("#scatter-analysis").click(function() {
            var d = new Date(); // To prevent image caching
            updateAnalysisImage("/generate_scatter?" + d.getTime());
        });

        // Click handler for correlation analysis
        $("#correlation-analysis").click(function() {
            var d = new Date(); // To prevent image caching
            updateAnalysisImage("/generate_correlation?" + d.getTime());
        });
        $("#start-ml").click(function() {
            $("#analysis-image").hide();  // Hide the image
            $("#ml-options").show();  // Show options for ML type
        });


        // Handlers for choosing ML type and sending data to the server
        $("#classification, #regression").click(function() {
            var mode = $(this).attr('id');
            $.ajax({
                url: '/start_ml',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({mode: mode}),
                success: function(response) {
                    // Display the summary
                    $("#summary-label").text(response.label);
                    $("#summary-excluded-features").text(response.excluded_features.join(', '));
                    $("#summary-task-type").text(response.mode);
                    $("#summary-time-series").text(response.time_series);
                    $("#summary").show();
                    alert('Model training started in ' + mode + ' mode.');
                },
                error: function() {
                    alert('Error starting machine learning.');
                }
            });
        });
        $("#confirm-training").click(function() {
            var mode = $("#summary-task-type").text();  // Retrieve the mode from the summary
            $.ajax({
                url: '/confirm_training',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({mode: mode}),
                success: function(response) {
                    alert('Training completed successfully!');
                    $("#start-testing").show();
                },
                error: function() {
                    alert('Error during training.');
                }
            });
        });
        $("#start-testing").click(function() {
            $("#test-data-upload").show();  // Show the test data upload section
        });

        $("#test-data-form").submit(function(event) {
            event.preventDefault();  // Prevent the default form submission
            var formData = new FormData(this);
            $.ajax({
                url: '/upload-test-data',
                type: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                success: function(response) {
                    $("#message1").text(response.message).show();  // 显示消息
                    setTimeout(function() {
                        $("#message1").hide();
                        $("#threshold-input").val('');  // Clear and show the threshold input
                        $("#threshold-input").show();
                        $("#show-results").show();
                    }, 3000);

                },
                error: function() {
                    $("#test-summary").text("Test data upload failed.").show();
                }
            });
        });
        $(document).ready(function() {
            $("#show-results").click(function() {
                var threshold = $("#threshold-input").val(); // Get the optional threshold value
                $(this).hide();  // Optionally hide the button after clicking
                $.ajax({
                    url: '/evaluate',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ threshold: threshold }),
                    success: function(response) {
                        $("#result-buttons").show();  // Show result buttons on successful evaluation
                        $("#evaluation-message").text(response.message).show();  // Ensure this element exists
                    },
                    error: function() {
                        $("#evaluation-message").text("Evaluation failed. Please try again.").show();
                    }
                });
            });
        });


        // Event handlers for result buttons
        $("#scatter-plot").click(function() {
            updateResultImage('/static/result_images/scatter.png'); // Path to the scatter plot image
        });

        $("#f1-score").click(function() {
            updateResultImage('/static/result_images/confusion_matrix.png'); // Path to the confusion matrix image
        });

        $("#feature-analysis").click(function() {
            updateResultImage('/static/result_images/importance.png'); // Path to the feature importance image
        });
    });
    </script>
</head>
<body>
    <h1>Upload Train data</h1>
    <form enctype="multipart/form-data">
        <input type="text" name="taskname" placeholder="Enter task name" required />
        <input type="file" name="datafile" required />
        <input type="submit" value="Upload" />
    </form>
    <div id="message" style="display:none;"></div> <!-- 消息显示区域 -->
    <button id="display-btn" style="display:none;">Display Data</button> <!-- 显示数据按钮 -->
    <div id="data-display" style="display:none;"></div> <!-- 数据显示区域 -->
    <button id="analyze-btn" style="display:none;">Start Data Analysis</button> <!-- 数据分析按钮 -->
    <div id="learning-options" style="display:none;">
        <button id="unsupervised-btn">Unsupervised Learning</button>
        <button id="supervised-btn">Supervised Learning</button>
    </div>
    <div id="supervised-options" style="display:none;">
        <!-- Label for specifying the label column -->
        <label for="label-input">Specify Label:</label>
        <input type="text" id="label-input" placeholder="Enter the label column name">

        <!-- Label for specifying features to exclude -->
        <label for="exclude-features-input">Exclude Features:</label>
        <input type="text" id="exclude-features-input" placeholder="Enter features to exclude, separated by commas">

        <!-- Dropdown to specify if the data is time-series -->
        <label for="time-series-select">Is Time-Series Data:</label>
        <select id="time-series-select">
            <option value="false">No</option>
            <option value="true">Yes</option>
        </select>

        <!-- Text input for specifying the group by feature -->
        <label for="group-by-input">Group By (optional):</label>
        <input type="text" id="group-by-input" placeholder="Enter the feature to group by">

        <button id="submit-supervised-btn">Set Options</button>
    </div>


    <!-- Visualization button, initially hidden -->
    <button id="visualization" style="display:none;">Visualization Options</button>

    <!-- Analysis buttons, initially hidden -->
    <div id="analysis-options" style="display:none;">
        <button id="histogram-analysis">Histogram Analysis</button>
        <button id="scatter-analysis">Scatter Analysis</button>
        <button id="correlation-analysis">Correlation Analysis</button>
        <button id="start-ml">Start Auto Machine Learning</button>
    </div>
    <div id="ml-options" style="display:none;">
        <button id="classification">Classification</button>
        <button id="regression">Regression</button>
    </div>
    <img id="analysis-image" src="" alt="Analysis Image" style="max-width: 100%; height: auto; display: none;">
    <div id="summary" style="display:none;">
        <h3>Summary of Machine Learning Setup</h3>
        <p><strong>Label:</strong> <span id="summary-label"></span></p>
        <p><strong>Excluded Features:</strong> <span id="summary-excluded-features"></span></p>
        <p><strong>Task Type:</strong> <span id="summary-task-type"></span></p>
        <p><strong>Is Time Series:</strong> <span id="summary-time-series"></span></p>
        <button id="confirm-training">Confirm and Start Training</button>
    </div>
    <button id="start-testing" style="display:none;">Start Testing</button>
    <div id="test-data-upload" style="display:none;">
        <h2>Upload Test Data</h2>
        <form id="test-data-form" enctype="multipart/form-data">
            <input type="file" name="testdatafile" />
            <input type="submit" value="Upload Test Data" />
        </form>
    </div>
    <div id="message1" style="display:none;"></div> <!-- 消息显示区域 -->
    <div id="upload-response">
        <input type="number" id="threshold-input" placeholder="Enter threshold (optional)" style="display: none;">
        <button id="show-results" style="display:none;">Show Results</button>
        <div id="result-buttons" style="display:none;">
            <!-- Result buttons -->
            <button id="scatter-plot">Scatter Plot</button>
            <button id="f1-score">F1 Score</button>
            <button id="feature-analysis">Feature Analysis</button>
        </div>
        <img id="result-image" src="" alt="Result Image" style="max-width: 100%; height: auto; display: none;">
        <div id="evaluation-message" style="display:none;"></div> <!-- Ensure this is in your HTML -->
    </div>

</body>
</html>
